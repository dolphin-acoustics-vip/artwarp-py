# Sync docs/ to GitHub Wiki on push to main when docs change.
# Wiki pages are flat: docs/README.md → Home, docs/user/X.md → User-X, docs/dev/X.md → Dev-X.

name: Sync docs to Wiki

on:
  push:
    branches: [main, master]
    paths:
      - "docs/**"

# Wiki lives in a separate repo (.wiki.git); pushing to it requires contents write.
permissions:
  contents: write

jobs:
  sync-wiki:
    name: Sync docs to Wiki
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Clone or init wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git clone --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.wiki.git" wiki 2>/dev/null; then
            echo "Wiki cloned."
          else
            mkdir -p wiki && cd wiki
            git init
            git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.wiki.git"
            cd ..
          fi

      - name: Copy and flatten docs into wiki
        run: |
          set -e
          WIKI_DIR="wiki"
          SRC="main-repo/docs"
          # Home
          if [ -f "$SRC/README.md" ]; then
            cp "$SRC/README.md" "$WIKI_DIR/Home.md"
          fi
          # user/*.md → User-*.md
          for f in "$SRC"/user/*.md; do
            [ -f "$f" ] || continue
            base=$(basename "$f" .md)
            cp "$f" "$WIKI_DIR/User-${base}.md"
          done
          # dev/*.md → Dev-*.md
          for f in "$SRC"/dev/*.md; do
            [ -f "$f" ] || continue
            base=$(basename "$f" .md)
            cp "$f" "$WIKI_DIR/Dev-${base}.md"
          done
          # Rewrite internal links so wiki pages link to each other
          for f in "$WIKI_DIR"/*.md; do
            [ -f "$f" ] || continue
            sed -i.bak \
              -e 's|(user/\([^)]*\)\.md)|(User-\1)|g' \
              -e 's|(dev/\([^)]*\)\.md)|(Dev-\1)|g' \
              -e 's|(README\.md)|(Home)|g' \
              "$f"
            rm -f "${f}.bak"
          done

      - name: Commit and push wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if [ -z "$(git status --porcelain)" ]; then
            echo "No wiki changes to push."
            exit 0
          fi
          git commit -m "Sync wiki from docs/ (automated)"
          # Push current branch to origin (wiki default is usually master)
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.wiki.git" HEAD
